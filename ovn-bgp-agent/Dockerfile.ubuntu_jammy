ARG FROM=ubuntu:22.04
FROM ${FROM} AS builder

ARG PROJECT=ovn-bgp-agent
ARG PROJECT_REF=master
ARG PIP_INDEX_URL=https://pypi.python.org/simple
ARG PIP_TRUSTED_HOST=pypi.python.org

ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    PIP_BREAK_SYSTEM_PACKAGES=1

RUN set -ex && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        git \
        python3 \
        python3-pip \
        python3-dev \
        gcc && \
    rm -rf /var/lib/apt/lists/*

RUN python3 -m pip install --no-cache-dir \
    --ignore-installed --upgrade pip setuptools wheel

WORKDIR /tmp
RUN git clone --depth 1 --branch ${PROJECT_REF} \
        https://opendev.org/openstack/${PROJECT}.git && \
    cd ${PROJECT} && \
    pip3 install --no-cache-dir \
        --index-url ${PIP_INDEX_URL} \
        --trusted-host ${PIP_TRUSTED_HOST} \
        -c https://releases.openstack.org/constraints/upper/${PROJECT_REF} \
        --prefix=/install \
        .

FROM ${FROM}

LABEL maintainer="OpenStack Helm Team" \
      org.opencontainers.image.title="OVN BGP Agent" \
      org.opencontainers.image.description="BGP agent for OVN" \
      org.opencontainers.image.source="https://opendev.org/openstack/ovn-bgp-agent"

ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    PIP_BREAK_SYSTEM_PACKAGES=1 \
    PATH=/install/local/bin:/install/bin:$PATH \
    PYTHONPATH=/install/local/lib/python3.10/dist-packages

RUN set -ex && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        python3 \
        iproute2 \
        iptables \
        openvswitch-common \
        openvswitch-switch \
        frr-pythontools \
        jq sudo && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN groupadd -g 42424 openvswitch && \
    groupadd -g 42494 ovn-bgp-agent && \
    useradd -m -u 42494 -g 42494 -G openvswitch \
      -d /var/lib/ovn-bgp-agent -s /bin/bash ovn-bgp-agent && \
    mkdir -p /etc/ovn-bgp-agent /var/log/ovn-bgp-agent /run/ovn-bgp-agent && \
    chown -R ovn-bgp-agent:ovn-bgp-agent \
        /var/lib/ovn-bgp-agent \
        /etc/ovn-bgp-agent \
        /var/log/ovn-bgp-agent \
        /run/ovn-bgp-agent

COPY --from=builder /install /install

# Configure sudo for privsep
RUN ln -sf /install/local/bin/privsep-helper /usr/local/bin/privsep-helper && \
    echo "Defaults env_keep += \"PYTHONPATH\"" > /etc/sudoers.d/ovn-bgp-agent && \
    echo "ALL ALL=(root) NOPASSWD: /usr/local/bin/privsep-helper" >> /etc/sudoers.d/ovn-bgp-agent && \
    echo "ALL ALL=(root) NOPASSWD: /install/local/bin/privsep-helper" >> /etc/sudoers.d/ovn-bgp-agent && \
    chmod 0440 /etc/sudoers.d/ovn-bgp-agent && \
    visudo -c -f /etc/sudoers.d/ovn-bgp-agent

# Prepare writable directories
RUN mkdir -p /tmp /var/tmp && \
    chown ovn-bgp-agent:ovn-bgp-agent /tmp /var/tmp

USER ovn-bgp-agent
WORKDIR /var/lib/ovn-bgp-agent

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD pgrep -f "ovn-bgp-agent" > /dev/null || exit 1

CMD ["/install/local/bin/ovn-bgp-agent", "--config-dir", "/etc/ovn-bgp-agent"]